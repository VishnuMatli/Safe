<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }
        .leaflet-container {
            font-family: 'Inter', sans-serif;
        }
        .info-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .alert-item, .fir-item {
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .sidebar {
            width: 100%;
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            position: fixed;
            z-index: 100;
            top: 0;
            bottom: 0;
            left: 0;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .sidebar-right {
            transform: translateX(100%);
            right: 0;
            left: auto;
        }
        .sidebar-right.active {
            transform: translateX(0);
        }
        .toggle-button {
            z-index: 1000;
        }
        .hidden-mobile {
            display: none;
        }
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                width: 320px;
                position: relative;
            }
            .sidebar-right {
                transform: translateX(0);
                width: 320px;
                position: relative;
            }
            .hidden-mobile {
                display: flex;
            }
        }
        /* Custom Message Box Styles */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            text-align: center;
        }
        .message-box button {
            margin-top: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .clickable-alert {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .clickable-alert:hover {
            background-color: #fee2e2;
        }
    </style>
</head>
<body class="flex min-h-screen relative">
    <audio id="alert-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" preload="auto"></audio>

    <div id="sidebar-left" class="sidebar bg-white shadow-lg p-6 overflow-y-auto flex-col">
        <div class="flex justify-between items-center mb-6 md:hidden">
            <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
            <button id="toggle-sidebar-btn" class="text-gray-500 hover:text-gray-900">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="hidden md:flex items-center space-x-2 mb-6">
            <img src="/images/ic_launcher.png" alt="Logo" class="h-10 w-10">
            <h1 class="text-2xl font-bold text-gray-900">Authority Dashboard</h1>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="info-card bg-blue-600 text-white p-4 rounded-lg shadow-md">
                <div class="text-2xl font-bold" id="total-tourists">0</div>
                <div class="text-sm">Total Tourists</div>
            </div>
            <div class="info-card bg-red-600 text-white p-4 rounded-lg shadow-md">
                <div class="text-2xl font-bold" id="active-alerts">0</div>
                <div class="text-sm">Active Alerts</div>
            </div>
        </div>

        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3">Anomaly Alerts</h2>
            <div id="anomaly-alerts" class="space-y-2">
                </div>
        </div>

        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3">Panic Button Alerts</h2>
            <div id="panic-alerts" class="space-y-2">
                </div>
        </div>
        
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3">Tourist ID Records</h2>
            <div class="flex flex-col space-y-2">
                <input type="text" id="tourist-id-input" placeholder="Enter Tourist ID (e.g., T101)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="search-button" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Search</button>
                <button id="show-all-button" class="w-full bg-gray-500 text-white font-semibold py-2 rounded-lg hover:bg-gray-600 mt-2">Show All Tourists</button>
            </div>
            <div id="tourist-info" class="info-card mt-4 p-4 hidden">
                <h3 class="font-bold text-lg mb-2">Tourist Details</h3>
                <p><strong>Name:</strong> <span id="tourist-name"></span></p>
                <p><strong>KYC:</strong> <span id="tourist-kyc"></span></p>
                <p><strong>Itinerary:</strong> <span id="tourist-itinerary"></span></p>
                <p><strong>Emergency Contacts:</strong> <span id="tourist-contacts"></span></p>
                <p><strong>Alert History:</strong> <span id="tourist-alerts"></span></p>
                <p><strong>Current Location:</strong> <span id="tourist-location"></span></p>
                <button id="efir-button" class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg mt-4 hover:bg-red-700">Generate E-FIR</button>
            </div>
        </div>

        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3">E-FIR Records</h2>
            <div id="fir-records" class="space-y-2">
                </div>
        </div>

        <div class="mt-auto pt-4">
            <button id="logout-button" class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700">Logout</button>
        </div>
    </div>

    <div id="map-container" class="flex-1 min-h-screen">
        <button id="toggle-sidebar-map-btn" class="absolute top-4 left-4 z-10 p-2 bg-white rounded-full shadow-lg md:hidden toggle-button">
            <i class="fas fa-bars text-gray-700"></i>
        </button>
        <div id="map"></div>
    </div>

    <div id="message-box" class="message-box hidden">
        <p id="message-text">Message content here.</p>
        <button onclick="hideMessage()">OK</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script>
        let hasInteracted = false;
        function handleUserInteraction() {
            if (!hasInteracted) {
                hasInteracted = true;
                document.body.removeEventListener('mousedown', handleUserInteraction);
            }
        }
        document.body.addEventListener('mousedown', handleUserInteraction);

        window.onload = function() {
            // --- SOS client and State Management ---
            let sosTourist = null;
            let panicAlerts = [];
            let eFirs = [];
            
            // --- Map Initialization ---
            let map = null;
            let sosMarker = null;

            function initMap() {
                const mapElement = document.getElementById('map');
                if (mapElement) {
                    map = L.map('map', { zoomControl: false }).setView([28.6, 77.2], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    L.control.zoom({
                        position: 'bottomright'
                    }).addTo(map);
                    
                    setTimeout(() => {
                        map.invalidateSize();
                        updateMap();
                    }, 100);

                    window.addEventListener('resize', () => {
                        map.invalidateSize();
                    });
                }
            }
            
            function updateMap() {
                if (sosMarker) {
                    map.removeLayer(sosMarker);
                    sosMarker = null;
                }

                if (sosTourist) {
                    const markerColor = 'red';
                    const markerSize = '1.5rem';
                    const markerHtmlStyles = `background-color: ${markerColor}; width: ${markerSize}; height: ${markerSize}; display: block; left: -0.5rem; top: -0.5rem; position: relative; border-radius: 2rem 2rem 0; transform: rotate(45deg); border: 1px solid #FFFFFF;`;
                    
                    const icon = L.divIcon({
                        className: "my-custom-pin",
                        iconAnchor: [0, 24],
                        popupAnchor: [0, -36],
                        html: `<span style="${markerHtmlStyles}" />`
                    });

                    sosMarker = L.marker([sosTourist.lat, sosTourist.lng], { icon: icon, zIndexOffset: 100 }).addTo(map);
                    sosMarker.bindPopup(`<b>SOS Alert!</b><br>ID: ${sosTourist.id}<br>Last seen: ${sosTourist.location}`);
                }
            }
            
            // --- UI Updates ---
            const totalTouristsEl = document.getElementById('total-tourists');
            const activeAlertsEl = document.getElementById('active-alerts');
            const panicAlertsEl = document.getElementById('panic-alerts');
            const firRecordsEl = document.getElementById('fir-records');
            const logoutButton = document.getElementById('logout-button');
            const alertSound = document.getElementById('alert-sound');

            function renderAlerts() {
                panicAlertsEl.innerHTML = '';
                let totalAlerts = 0;

                panicAlerts.forEach(alert => {
                    totalAlerts++;
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item bg-red-100 text-red-800 p-3 rounded-lg shadow-sm flex flex-col items-start clickable-alert';
                    alertDiv.innerHTML = `
                        <div onclick="findTouristOnMap('${alert.id}')">
                            <strong>Panic Button:</strong> ${alert.id}<br>
                            Last seen: ${alert.location}<br>
                            Time: ${alert.timestamp}
                        </div>
                        <button onclick="generateEfirFromAlert('${alert.id}')" class="bg-red-700 text-white font-semibold text-xs py-1 px-3 rounded-lg mt-2 hover:bg-red-800 self-end">
                            Generate E-FIR
                        </button>`;
                    panicAlertsEl.appendChild(alertDiv);
                });

                activeAlertsEl.textContent = totalAlerts;
                totalTouristsEl.textContent = panicAlerts.length;
            }

            function renderEfirList() {
                firRecordsEl.innerHTML = '';
                eFirs.forEach(fir => {
                    const firDiv = document.createElement('div');
                    firDiv.className = 'fir-item bg-gray-100 text-gray-800 p-3 rounded-lg shadow-sm';
                    firDiv.innerHTML = `<strong>E-FIR #${fir.id}</strong><br>Tourist ID: ${fir.touristId}<br>Time: ${fir.dateTime}<br>Details: ${fir.details}`;
                    firRecordsEl.appendChild(firDiv);
                });
            }

            function showMessage(message) {
                const messageBox = document.getElementById('message-box');
                const messageText = document.getElementById('message-text');
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
            }

            window.hideMessage = function() {
                const messageBox = document.getElementById('message-box');
                messageBox.classList.add('hidden');
            }
            
            window.findTouristOnMap = function(id) {
                const alert = panicAlerts.find(a => a.id === id);
                if (alert) {
                    sosTourist = alert;
                    const [latPart, lonPart] = alert.location.split(', ');
                    const lat = parseFloat(latPart.split(': ')[1]);
                    const lng = parseFloat(lonPart.split(': ')[1]);
                    
                    map.setView([lat, lng], 14);
                    updateMap();
                }
            };

            window.generateEfirFromAlert = function(touristId) {
                const alert = panicAlerts.find(a => a.id === touristId);
                if (alert) {
                    const firId = `FIR-PANIC-${touristId.replace('demo-', '')}-${eFirs.length + 1}`;
                    const newEfir = {
                        id: firId,
                        touristId: alert.id,
                        dateTime: new Date().toLocaleString(),
                        details: `E-FIR generated in response to Panic Button activation.`
                    };
                    eFirs.push(newEfir);
                    renderEfirList();
                    showMessage(`E-FIR #${newEfir.id} has been generated for Tourist ID: ${touristId}`);
                }
            }
            
            function logout() {
                window.location.href = 'index.html';
            }

            const searchButton = document.getElementById('search-button');
            const showAllButton = document.getElementById('show-all-button');
            const touristIdInput = document.getElementById('tourist-id-input');

            logoutButton.addEventListener('click', logout);

            const ws = new WebSocket('wss://100.76.187.58:3000');

            ws.onopen = () => {
                console.log('Connected to WebSocket server');
            };

            ws.onmessage = event => {
                const data = JSON.parse(event.data);
                if (data.type === 'sos-alert') {
                    const alert = data.payload;

                    const isDuplicate = panicAlerts.some(existingAlert => existingAlert.id === alert.id);
                    if (isDuplicate) {
                        return;
                    }

                    const newSosTourist = {
                        id: alert.id,
                        lat: alert.lat,
                        lng: alert.lon,
                        location: `Lat: ${alert.lat.toFixed(4)}, Lon: ${alert.lon.toFixed(4)}`,
                        timestamp: alert.timestamp
                    };

                    panicAlerts.push(newSosTourist);
                    renderAlerts();
                    
                    sosTourist = newSosTourist;

                    const alertMessage = `NEW PANIC ALERT!\nTourist ID: ${alert.id}\nLocation: ${newSosTourist.location}\nTime: ${alert.timestamp}`;
                    showMessage(alertMessage);

                    if (hasInteracted && alertSound) {
                        alertSound.play().catch(e => console.error("Error playing sound:", e));
                    }
                    
                    map.setView([newSosTourist.lat, newSosTourist.lng], 12);
                    updateMap();
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('Disconnected from WebSocket server');
            };

            initMap();
            
            totalTouristsEl.textContent = panicAlerts.length;
            document.getElementById('search-button').style.display = 'none';
            document.getElementById('show-all-button').style.display = 'none';
            document.getElementById('tourist-id-input').style.display = 'none';
        
            const toggleSidebar = () => {
                const sidebar = document.getElementById('sidebar-left');
                sidebar.classList.toggle('active');
            };

            const toggleButton = document.getElementById('toggle-sidebar-map-btn');
            const closeButton = document.getElementById('toggle-sidebar-btn');
            
            if(toggleButton) {
                toggleButton.addEventListener('click', toggleSidebar);
            }
            if(closeButton) {
                closeButton.addEventListener('click', toggleSidebar);
            }
        }
    </script>
</body>
</html>